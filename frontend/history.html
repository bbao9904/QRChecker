<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Lá»‹ch sá»­ - QR Checker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Quicksand:400,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
<header class="site-header">
  <nav class="nav">
    <div class="nav__brand">
      <a href="index.html" class="nav__logo">
        <img src="assets/qr-checker-logo.png" alt="QR Checker" class="nav__logo-img">
      </a>
      <span class="nav__title">QR Checker</span>
    </div>
    <input type="checkbox" id="nav-toggle">
    <label for="nav-toggle" class="nav__toggle"><span></span></label>
    <div class="nav__links">
      <a href="about.html">Giá»›i thiá»‡u</a>
      <a href="guide.html">HÆ°á»›ng dáº«n</a>
      <a href="create.html">Táº¡o mÃ£ QR</a>
      <a href="history.html" class="active">Lá»‹ch sá»­</a>
      <a id="nav-auth" class="btn-small" href="login.html">ÄÄƒng nháº­p</a>
    </div>
  </nav>
</header>

<!-- Premium Guard -->
<section id="premium-guard" class="scan-wrapper" style="padding-top:40px; display:none;">
  <div class="card" style="max-width:720px;margin:0 auto;text-align:center;">
    <h2>â­ Chá»©c nÄƒng Premium</h2>
    <p class="small">TÃ­nh nÄƒng Xem lá»‹ch sá»­ chá»‰ dÃ nh cho tÃ i khoáº£n Premium.</p>
    <p style="margin: 16px 0;">NÃ¢ng cáº¥p ngay Ä‘á»ƒ sá»­ dá»¥ng khÃ´ng giá»›i háº¡n!</p>
    <div class="hero__actions" style="margin-top:12px; display:flex; justify-content:center; gap: 12px;">
      <a href="pricing.html" class="btn btn--primary">ğŸš€ Xem cÃ¡c gÃ³i Premium</a>
      <a href="account.html" class="btn btn--outline">TÃ i khoáº£n</a>
    </div>
  </div>
</section>

<!-- Auth Guard -->
<section id="auth-guard" class="scan-wrapper" style="padding-top:40px; display:none;">
  <div class="card" style="max-width:720px;margin:0 auto;text-align:center;">
    <h2>Báº¡n cáº§n Ä‘Äƒng nháº­p</h2>
    <p class="small">HÃ£y Ä‘Äƒng nháº­p Ä‘á»ƒ xem Lá»‹ch sá»­ quÃ©t.</p>
    <div class="hero__actions" style="margin-top:12px; display:flex; justify-content:center;">
      <a id="guard-login" class="btn btn--primary">ÄÄƒng nháº­p</a>
    </div>
  </div>
</section>

<section id="feature-content" class="scan-wrapper" style="padding-top:40px; display:none;">
  <h1 class="section-title">Lá»‹ch sá»­</h1>
  
  <!-- Tabs -->
  <div class="history-tabs">
    <button class="history-tab active" data-tab="scan">ğŸ“± Lá»‹ch sá»­ QuÃ©t mÃ£</button>
    <button class="history-tab" data-tab="create">ğŸ¨ Lá»‹ch sá»­ Táº¡o mÃ£</button>
  </div>
  
  <!-- Lá»‹ch sá»­ QuÃ©t mÃ£ -->
  <div id="tab-scan" class="tab-content active">
    <div class="card" style="max-width:1200px;margin:0 auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3>ğŸ“± Lá»‹ch sá»­ QuÃ©t mÃ£ QR</h3>
        <button id="clear-scan-btn" class="btn btn--outline" style="padding: 8px 16px;">ğŸ—‘ï¸ XÃ³a táº¥t cáº£</button>
      </div>
      
      <div id="scan-history-list" class="history-list">
        <div class="loading"><div class="spinner"></div><span>Äang táº£i...</span></div>
      </div>
    </div>
  </div>
  
  <!-- Lá»‹ch sá»­ Táº¡o mÃ£ -->
  <div id="tab-create" class="tab-content">
    <div class="card" style="max-width:1200px;margin:0 auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3>ğŸ¨ Lá»‹ch sá»­ Táº¡o mÃ£ QR</h3>
        <button id="clear-create-btn" class="btn btn--outline" style="padding: 8px 16px;">ğŸ—‘ï¸ XÃ³a táº¥t cáº£</button>
      </div>
      
      <div id="create-history-list" class="history-list">
        <div class="loading"><div class="spinner"></div><span>Äang táº£i...</span></div>
      </div>
    </div>
  </div>
</section>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="footer-grid">
    <div>
      <h4>QR Checker</h4>
      <p class="small">Ná»n táº£ng kiá»ƒm tra & táº¡o QR an toÃ n.</p>
    </div>
    <div>
      <h5>Chá»©c nÄƒng</h5>
      <ul>
        <li><a href="#scan">QuÃ©t mÃ£ QR</a></li>
        <li><a href="create.html">Táº¡o mÃ£</a></li>
        <li><a href="history.html">Lá»‹ch sá»­</a></li>
      </ul>
    </div>
    <div>
      <h5>Há»— trá»£</h5>
      <ul>
        <li><a href="guide.html">HÆ°á»›ng dáº«n</a></li>
        <li><a href="about.html">Giá»›i thiá»‡u</a></li>
        <li><a href="privacy.html">ChÃ­nh sÃ¡ch báº£o máº­t</a></li>
      </ul>
    </div>
  </div>
  <div class="copy small">Â© 2025 QR Checker</div>
</footer>

<script>
// Auth guard - Cáº¬P NHáº¬T
(async function(){
  const next = location.pathname + location.search + location.hash;
  const a = document.getElementById('nav-auth');
  const authGuard = document.getElementById('auth-guard');
  const premiumGuard = document.getElementById('premium-guard');
  const content = document.getElementById('feature-content');
  
  const r = await fetch('/me', {credentials:'include'}).catch(()=>null);
  const authed = !!r && r.status === 200;

  if(a){
    if(authed){ a.textContent='TÃ i khoáº£n'; a.href='account.html'; }
    else{ a.textContent='ÄÄƒng nháº­p'; a.href='login.html?next=' + encodeURIComponent(location.pathname); }
  }
  
  if(!authed){
    if(content) content.style.display='none';
    if(premiumGuard) premiumGuard.style.display='none';
    if(authGuard) authGuard.style.display='block';
    const btn = document.getElementById('guard-login');
    if(btn) btn.href = 'login.html?next=' + encodeURIComponent(next);
    return;
  }
  
  // Kiá»ƒm tra subscription
  const subRes = await fetch('/subscription/info', {credentials:'include'}).catch(()=>null);
  const subData = subRes && subRes.status === 200 ? await subRes.json() : null;
  
  if(subData && (subData.is_admin || subData.has_subscription)){
    if(content) content.style.display='block';
    if(authGuard) authGuard.style.display='none';
    if(premiumGuard) premiumGuard.style.display='none';
    loadHistory();
  } else {
    if(content) content.style.display='none';
    if(authGuard) authGuard.style.display='none';
    if(premiumGuard) premiumGuard.style.display='block';
  }
})();

// Tab switching
const historyTabs = document.querySelectorAll('.history-tab');
const tabContents = document.querySelectorAll('.tab-content');

historyTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.dataset.tab;
    
    historyTabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    tabContents.forEach(content => content.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
  });
});

// Load history
async function loadHistory() {
  await loadScanHistory();
  await loadCreateHistory();
}

async function loadScanHistory() {
  const listDiv = document.getElementById('scan-history-list');
  
  try {
    const response = await fetch('/history/scan', { credentials: 'include' });
    const data = await response.json();
    
    if (data.status === 'ok' && data.history.length > 0) {
      listDiv.innerHTML = data.history.map(item => {
        const isUrl = item.qr_type === 'url';
        const isSafe = item.is_safe;
        const canClick = isUrl && isSafe && item.details.malicious === 0 && item.details.suspicious === 0;
        
        let contentDisplay = '';
        if (canClick) {
          contentDisplay = `<a href="${escapeHtml(item.qr_content)}" target="_blank" rel="noopener noreferrer" class="history-link">${escapeHtml(item.qr_content.substring(0, 80))}${item.qr_content.length > 80 ? '...' : ''}</a>`;
        } else {
          contentDisplay = `<code>${escapeHtml(item.qr_content.substring(0, 80))}${item.qr_content.length > 80 ? '...' : ''}</code>`;
        }
        
        return `
          <div class="history-item ${item.is_safe ? 'safe' : 'danger'}">
            <div class="history-header">
              <span class="history-type">${getTypeIcon(item.qr_type)} ${getTypeName(item.qr_type)}</span>
            </div>
            <div class="history-content">
              <p>
                ${contentDisplay}
                ${item.is_safe ? 
                  '<span class="tag safe">âœ…</span>' : 
                  '<span class="tag danger">âš ï¸</span>'
                }
                ${!item.is_safe && item.details.malicious ? 
                  `<span class="tag danger">ğŸ”´ ${item.details.malicious}/${item.details.total}</span>` : 
                  ''
                }
                ${canClick ? '<span class="tag neutral" style="margin-left: 4px;">ğŸ”— Click Ä‘á»ƒ má»Ÿ</span>' : ''}
              </p>
            </div>
            <div class="history-actions">
              <button class="btn-icon" onclick="deleteScanItem(${item.id})" title="XÃ³a">ğŸ—‘ï¸</button>
            </div>
          </div>
        `;
      }).join('');
    } else {
      listDiv.innerHTML = '<p class="empty-message">ChÆ°a cÃ³ lá»‹ch sá»­ quÃ©t mÃ£ QR nÃ o.</p>';
    }
  } catch (error) {
    listDiv.innerHTML = '<p class="error-message">âŒ KhÃ´ng thá»ƒ táº£i lá»‹ch sá»­: ' + error.message + '</p>';
  }
}

async function loadCreateHistory() {
  const listDiv = document.getElementById('create-history-list');
  
  try {
    const response = await fetch('/history/create', { credentials: 'include' });
    const data = await response.json();
    
    if (data.status === 'ok' && data.history.length > 0) {
      listDiv.innerHTML = data.history.map(item => {
        const isUrl = item.qr_type === 'url';
        const canClick = isUrl && looks_like_url_content(item.qr_content);
        
        let contentDisplay = '';
        if (canClick) {
          contentDisplay = `<a href="${escapeHtml(item.qr_content)}" target="_blank" rel="noopener noreferrer" class="history-link">${escapeHtml(item.qr_content.substring(0, 80))}${item.qr_content.length > 80 ? '...' : ''}</a>`;
        } else {
          contentDisplay = `<code>${escapeHtml(item.qr_content.substring(0, 80))}${item.qr_content.length > 80 ? '...' : ''}</code>`;
        }
        
        return `
          <div class="history-item create">
            ${item.qr_image ? `<img src="${item.qr_image}" alt="QR" class="history-qr-preview">` : ''}
            <div class="history-content">
              <div class="history-header" style="margin-bottom: 6px;">
                <span class="history-type">${getTypeIcon(item.qr_type)} ${getTypeName(item.qr_type)}</span>
              </div>
              <p>
                ${contentDisplay}
                ${canClick ? '<span class="tag neutral" style="margin-left: 4px;">ğŸ”— Click Ä‘á»ƒ má»Ÿ</span>' : ''}
              </p>
            </div>
            <div class="history-actions">
              ${item.qr_image ? `<a href="${item.qr_image}" download="qrcode.png" class="btn-icon" title="Táº£i">ğŸ’¾</a>` : ''}
              <button class="btn-icon" onclick="deleteCreateItem(${item.id})" title="XÃ³a">ğŸ—‘ï¸</button>
            </div>
          </div>
        `;
      }).join('');
    } else {
      listDiv.innerHTML = '<p class="empty-message">ChÆ°a cÃ³ lá»‹ch sá»­ táº¡o mÃ£ QR nÃ o.</p>';
    }
  } catch (error) {
    listDiv.innerHTML = '<p class="error-message">âŒ KhÃ´ng thá»ƒ táº£i lá»‹ch sá»­: ' + error.message + '</p>';
  }
}

// Delete functions
async function deleteScanItem(id) {
  if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a lá»‹ch sá»­ nÃ y?')) return;
  
  try {
    const response = await fetch(`/history/scan/${id}`, { 
      method: 'DELETE', 
      credentials: 'include' 
    });
    const data = await response.json();
    
    if (data.status === 'ok') {
      await loadScanHistory();
    } else {
      alert('âŒ KhÃ´ng thá»ƒ xÃ³a: ' + data.msg);
    }
  } catch (error) {
    alert('âŒ Lá»—i: ' + error.message);
  }
}

async function deleteCreateItem(id) {
  if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a lá»‹ch sá»­ nÃ y?')) return;
  
  try {
    const response = await fetch(`/history/create/${id}`, { 
      method: 'DELETE', 
      credentials: 'include' 
    });
    const data = await response.json();
    
    if (data.status === 'ok') {
      await loadCreateHistory();
    } else {
      alert('âŒ KhÃ´ng thá»ƒ xÃ³a: ' + data.msg);
    }
  } catch (error) {
    alert('âŒ Lá»—i: ' + error.message);
  }
}

// Clear all
document.getElementById('clear-scan-btn').addEventListener('click', async () => {
  if (!confirm('âš ï¸ Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a Táº¤T Cáº¢ lá»‹ch sá»­ quÃ©t mÃ£?\n\nHÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!')) return;
  
  try {
    const response = await fetch('/history/scan/clear', { 
      method: 'DELETE', 
      credentials: 'include' 
    });
    const data = await response.json();
    
    if (data.status === 'ok') {
      alert('âœ… ' + data.msg);
      await loadScanHistory();
    } else {
      alert('âŒ KhÃ´ng thá»ƒ xÃ³a: ' + data.msg);
    }
  } catch (error) {
    alert('âŒ Lá»—i: ' + error.message);
  }
});

document.getElementById('clear-create-btn').addEventListener('click', async () => {
  if (!confirm('âš ï¸ Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a Táº¤T Cáº¢ lá»‹ch sá»­ táº¡o mÃ£?\n\nHÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c!')) return;
  
  try {
    const response = await fetch('/history/create/clear', { 
      method: 'DELETE', 
      credentials: 'include' 
    });
    const data = await response.json();
    
    if (data.status === 'ok') {
      alert('âœ… ' + data.msg);
      await loadCreateHistory();
    } else {
      alert('âŒ KhÃ´ng thá»ƒ xÃ³a: ' + data.msg);
    }
  } catch (error) {
    alert('âŒ Lá»—i: ' + error.message);
  }
});

// Helper functions
function getTypeIcon(type) {
  const icons = {
    url: 'ğŸ”—',
    text: 'ğŸ“',
    wifi: 'ğŸ“¶',
    phone: 'ğŸ“',
    sms: 'ğŸ’¬',
    email: 'âœ‰ï¸'
  };
  return icons[type] || 'â“';
}

function getTypeName(type) {
  const names = {
    url: 'URL',
    text: 'VÄƒn báº£n',
    wifi: 'WiFi',
    phone: 'Äiá»‡n thoáº¡i',
    sms: 'SMS',
    email: 'Email'
  };
  return names[type] || type;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function looks_like_url_content(content) {
  if (!content) return false;
  return /^(https?|ftp):\/\//i.test(content);
}
</script>
</body>
</html>