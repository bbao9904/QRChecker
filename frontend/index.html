<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>QR Checker</title>
  <link href="https://fonts.googleapis.com/css?family=Quicksand:400,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- Th√™m d√≤ng d∆∞·ªõi ƒë·ªÉ responsive tr√™n mobile -->
  <meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
    <!-- NAVBAR -->
    <header class="site-header">
        <nav class="nav">
            <div class="nav__brand">
                <a href="index.html" class="nav__logo">
                    <img src="https://upload.wikimedia.org/wikipedia/vi/thumb/2/2d/Logo_Tr%C6%B0%E1%BB%9Dng_%C4%90%E1%BA%A1i_h%E1%BB%8dc_FPT.svg/240px-Logo_Tr%C6%B0%E1%BB%9Dng_%C4%90%E1%BA%A1i_h%E1%BB%8dc_FPT.svg.png" alt="FPT">
                </a>
                <span class="nav__title">QR Checker</span>
            </div>
            <input type="checkbox" id="nav-toggle">
            <label for="nav-toggle" class="nav__toggle"><span></span></label>
            <div class="nav__links">
  <a href="about.html">Gi·ªõi thi·ªáu</a>
  <a href="guide.html">H∆∞·ªõng d·∫´n</a>
  <a href="create.html">T·∫°o m√£ QR</a>
  <a href="history.html">L·ªãch s·ª≠</a>
  <a id="nav-auth" class="btn-small" href="login.html">ƒêƒÉng nh·∫≠p</a>
</div>
        </nav>
    </header>

    <!-- HERO -->
    <section class="hero">
        <div class="hero__content">
            <h1>Ki·ªÉm tra & T·∫°o m√£ QR An To√†n</h1>
            <p>Qu√©t ‚Äì Ph√¢n t√≠ch ‚Äì C·∫£nh b√°o ‚Äì L·ªãch s·ª≠ ‚Äì T·∫°o m√£ QR b·∫£o m·∫≠t.</p>
            <div class="hero__actions">
                <a href="#scan" class="btn btn--primary">Qu√©t ngay</a>
                <a href="create.html" class="btn btn--primary">T·∫°o m√£ QR</a>
            </div>
        </div>
        <div class="hero__illustration">
            <div class="qr-mock">
                <div class="qr-box"></div>
                <span>SECURE</span>
            </div>
        </div>
    </section>

    <!-- FEATURES -->
    <section class="features">
        <div class="feature-card">
            <h3>Ph√¢n t√≠ch URL</h3>
            <p>Ki·ªÉm tra VirusTotal & c·∫£nh b√°o ƒë·ªôc h·∫°i/phishing.</p>
        </div>
        <div class="feature-card">
            <h3>Nh·∫≠n d·∫°ng n·ªôi dung</h3>
            <p>Tr√≠ch xu·∫•t & hi·ªÉn th·ªã n·ªôi dung vƒÉn b·∫£n / URL r√µ r√†ng.</p>
        </div>
        <div class="feature-card">
            <h3>Camera tr·ª±c ti·∫øp</h3>
            <p>Qu√©t th·ªùi gian th·ª±c b·∫±ng camera thi·∫øt b·ªã.</p>
        </div>
        <div class="feature-card">
            <h3>L·ªãch s·ª≠</h3>
            <p>L∆∞u & xem l·∫°i c√°c l·∫ßn ki·ªÉm tra g·∫ßn ƒë√¢y.</p>
        </div>
    </section>

    <!-- SCAN SECTION -->
    <section id="scan" class="scan-wrapper">
        <h2 class="section-title">Qu√©t / Ph√¢n t√≠ch m√£ QR</h2>
        <div class="scan-grid">
            <!-- Upload Card -->
            <div class="card card--scan">
                <h3>T·∫£i ·∫£nh / D√°n ·∫£nh</h3>
                <form id="uploadForm">
                    <div class="drop-area" id="drop-area">
                        <div id="drop-text">
                            <span class="emoji">üì∑</span>
                            <strong>K√©o & th·∫£ ·∫£nh v√†o ƒë√¢y</strong><br>
                            ho·∫∑c: ch·ªçn t·∫≠p tin / D√°n (Ctrl + V)
                        </div>
                        <input type="file" id="qrFile" accept="image/*;capture=camera">
                        <button type="button" class="btn btn--outline" id="selectFileBtn">Ch·ªçn ·∫£nh</button>
                        <img id="preview-img" class="preview-img" alt="">
                    </div>
                    <button type="submit" class="btn btn--primary full mt-1">Ph√¢n t√≠ch ·∫£nh</button>
                </form>
                <div class="or-line"><span>ho·∫∑c</span></div>
                <button id="cameraBtn" class="btn btn--accent full">Qu√©t b·∫±ng Camera</button>
                <div id="camera-area" class="camera-box" style="display:none;">
                   <div id="qr-reader"></div>
                   <div id="camera-error" class="error" style="display:none;margin-top:8px;"></div>
                   <div id="camPausedMsg" class="cam-paused-msg" style="display:none;">ƒê√£ t·∫°m d·ª´ng ‚Äì nh·∫•n ‚ÄúTi·∫øp t·ª•c‚Äù ƒë·ªÉ m·ªü l·∫°i</div>
                   <div class="cam-controls">
                       <button id="togglePauseCamera" type="button" class="btn btn--pause full mt-1">T·∫°m d·ª´ng</button>
                   </div>
                </div>
            </div>

            <!-- Result Card -->
            <div class="card card--result">
                <h3>K·∫øt qu·∫£ ph√¢n t√≠ch</h3>
                <div id="result" class="result-box muted">
                    <p>Ch∆∞a c√≥ d·ªØ li·ªáu. Qu√©t ho·∫∑c t·∫£i ·∫£nh ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- TEAM -->
    <section class="team">
        <h2 class="section-title small">Th√†nh vi√™n</h2>
        <ul class="team-list">
            <li>Hu·ª≥nh T·∫•n B·∫£o</li>
            <li>Nguy·ªÖn Minh Th√¥ng</li>
            <li>ƒê√°i Sƒ© H√†o</li>
            <li>Th√°i C√¥ng Tr∆∞·ªùng Thanh</li>
            <li>Tr·∫ßn Gia B·∫£o</li>
            <li>L√¢m B·∫£o Ng√¢n</li>
        </ul>
    </section>

    <!-- FOOTER -->
    <footer class="site-footer">
        <div class="footer-grid">
            <div>
                <h4>QR Checker</h4>
                <p class="small">N·ªÅn t·∫£ng ki·ªÉm tra & t·∫°o QR an to√†n.</p>
            </div>
            <div>
                <h5>Ch·ª©c nƒÉng</h5>
                <ul>
                    <li><a href="#scan">Qu√©t m√£ QR</a></li>
                    <li><a href="create.html">T·∫°o m√£</a></li>
                    <li><a href="history.html">L·ªãch s·ª≠</a></li>
                </ul>
            </div>
            <div>
                <h5>H·ªó tr·ª£</h5>
                <ul>
                    <li><a href="guide.html">H∆∞·ªõng d·∫´n</a></li>
                    <li><a href="about.html">Gi·ªõi thi·ªáu</a></li>
                </ul>
            </div>
        </div>
        <div class="copy small">¬© 2025 QR Checker</div>
    </footer>

<script>
/* ==== QR Logic (PH·∫¶N THAY ƒê·ªîI LI√äN QUAN PAUSE) ==== */
const uploadForm = document.getElementById('uploadForm');
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('qrFile');
const selectFileBtn = document.getElementById('selectFileBtn');
const previewImg = document.getElementById('preview-img');
const cameraBtn = document.getElementById('cameraBtn');
const cameraArea = document.getElementById('camera-area');
const togglePauseCamera = document.getElementById('togglePauseCamera');
const camPausedMsg = document.getElementById('camPausedMsg');
const resultDiv = document.getElementById('result');
const cameraError = document.getElementById('camera-error');

let html5QrCode;
let cameraActive = false;
let cameraPaused = false;
let lastDeviceId = null;
let usedFacingMode = false;

// Ch·ªëng qu√©t l·∫∑p
let scanLock = false;              // ch·∫∑n re-entry callback
let lastDecodedText = '';
let lastDecodedAt = 0;
const DUP_WINDOW_MS = 1200;        // b·ªè qua n·∫øu tr√πng trong ~1.2s
let scanRequestInFlight = false;   // ch·∫∑n g·ª≠i /scan tr√πng l√∫c ƒëang x·ª≠ l√Ω

/* ===== Helpers ===== */
function setResultHTML(html){ resultDiv.innerHTML = html; }
function showLoading(){
  setResultHTML('<div class="loading"><div class="spinner"></div><span>ƒêang ph√¢n t√≠ch...</span></div>');
}
function classifyStatus(data){
  if(data.wifi) return {label:'WiFi', cls:'tag accent'};
  if(data.email) return {label:'Email', cls:'tag neutral'};
  if(data.phone) return {label:'Phone', cls:'tag neutral'};
  if(data.sms) return {label:'SMS', cls:'tag neutral'};
  if(data.text) return {label:'Text', cls:'tag neutral'};
  if(data.vietqr_info) return {label:'VietQR', cls:'tag accent'};
  if(data.details){
    if(data.details.malicious>0) return {label:'Malicious', cls:'tag danger'};
    if(data.details.suspicious>0) return {label:'Suspicious', cls:'tag warn'};
    if(data.details.clean>0) return {label:'Clean', cls:'tag safe'};
  }
  if(data.result && data.result.includes('an to√†n')) return {label:'Safe', cls:'tag safe'};
  return {label:'Info', cls:'tag neutral'};
}
function resetPauseBtn(){
  cameraPaused = false;
  togglePauseCamera.textContent = 'T·∫°m d·ª´ng';
  togglePauseCamera.classList.remove('paused');
}

/* ===== Upload / Drag / Paste ===== */
selectFileBtn.onclick=()=>fileInput.click();
fileInput.addEventListener('change',e=>{
  if(e.target.files.length) handleFile(e.target.files[0]);
});
uploadForm.addEventListener('submit',e=>{
  e.preventDefault();
  if(!fileInput.files.length) return;
  handleFile(fileInput.files[0], true);
});
['dragenter','dragover'].forEach(ev=>{
  dropArea.addEventListener(ev,e=>{
    e.preventDefault(); dropArea.classList.add('dragover');
  });
});
['dragleave','drop'].forEach(ev=>{
  dropArea.addEventListener(ev,e=>{
    e.preventDefault(); dropArea.classList.remove('dragover');
  });
});
dropArea.addEventListener('drop',e=>{
  const f=e.dataTransfer.files;
  if(f.length) handleFile(f[0]);
});
window.addEventListener('paste',e=>{
  for(const item of e.clipboardData.items){
    if(item.type.includes('image')){
      handleFile(item.getAsFile());
      break;
    }
  }
});

/* ===== Camera Logic ===== */
cameraBtn.onclick = () => startCamera();

togglePauseCamera.onclick = async () => {
  if(!cameraPaused){
    // T·∫°m d·ª´ng (stop stream nh∆∞ng gi·ªØ kh·ªëi hi·ªÉn th·ªã + th√¥ng b√°o)
    await stopCamera(false);
    cameraPaused = true;
    togglePauseCamera.textContent = 'Ti·∫øp t·ª•c';
    togglePauseCamera.classList.add('paused');
    camPausedMsg.style.display='block';
  } else {
    // Ti·∫øp t·ª•c
    togglePauseCamera.textContent = 'ƒêang m·ªü l·∫°i...';
    togglePauseCamera.disabled = true;
    await startCamera(true);
    cameraPaused = false;
    togglePauseCamera.textContent = 'T·∫°m d·ª´ng';
    togglePauseCamera.classList.remove('paused');
    camPausedMsg.style.display='none';
    togglePauseCamera.disabled = false;
  }
};

async function startCamera(resume=false){
  if(cameraActive){ return; }
  camPausedMsg.style.display='none';
  cameraError.style.display='none';
  cameraArea.style.display='block';

  if(!window.Html5Qrcode){
    cameraError.style.display='block';
    cameraError.textContent='Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán html5-qrcode.';
    return;
  }
  if(!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");

  // N·∫øu resume v√† ƒë√£ c√≥ lastDeviceId th√¨ ∆∞u ti√™n d√πng l·∫°i
  let tried = false;
  if(resume && lastDeviceId){
    tried = true;
    try{
      await html5QrCode.start(
        { deviceId: lastDeviceId },
        { fps:10, qrbox:{ width:250, height:250 } },
        onDecoded
      );
      cameraActive = true;
      return;
    }catch(e){
      console.warn('Resume v·ªõi deviceId c≈© th·∫•t b·∫°i, th·ª≠ facingMode.', e);
    }
  }

  // Th·ª≠ facingMode environment tr∆∞·ªõc
  try{
    usedFacingMode = true;
    await html5QrCode.start(
      { facingMode:{ exact:"environment" } },
      { fps:10, qrbox:{ width:250, height:250 } },
      onDecoded
    );
    cameraActive = true;
  }catch(errFacing){
    usedFacingMode = false;
    // fallback sang camera ƒë·∫ßu ti√™n
    try{
      const devices = await Html5Qrcode.getCameras();
      if(!devices.length) throw new Error("Kh√¥ng t√¨m th·∫•y camera.");
      lastDeviceId = devices[0].id;
      await html5QrCode.start(
        { deviceId: lastDeviceId },
        { fps:10, qrbox:{ width:250, height:250 } },
        onDecoded
      );
      cameraActive = true;
    }catch(err){
      cameraActive = false;
      cameraError.style.display='block';
      cameraError.textContent = parseCameraError(err);
      console.error('Camera error:', err);
      cameraArea.style.display='none';
    }
  }
}

async function stopCamera(full=true){
  if(!html5QrCode){ cameraArea.style.display='none'; return; }
  try{ await html5QrCode.stop(); }catch(e){ console.warn('stop warn', e); }
  // Kh√¥ng g·ªçi clear() n·∫øu ch·ªâ pause (ƒë·ªÉ gi·ªØ DOM s·∫µn s√†ng) ‚Äì clear khi full ƒë√≥ng
  if(full){
    try{ await html5QrCode.clear(); }catch(e){ console.warn('clear warn', e); }
    cameraArea.style.display='none';
  }
  cameraActive = false;
}

function parseCameraError(err){
  const msg = (err && err.message) ? err.message : String(err);
  if (msg.includes('NotAllowedError')) return 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn camera.';
  if (msg.includes('NotFoundError')) return 'Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã camera.';
  if (msg.includes('NotReadableError')) return 'Camera ƒëang b·ªã ·ª©ng d·ª•ng kh√°c s·ª≠ d·ª•ng.';
  if (msg.includes('OverconstrainedError')) return 'Th√¥ng s·ªë camera kh√¥ng ph√π h·ª£p.';
  if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1')
    return 'Ch·∫°y tr√™n http://localhost ho·∫∑c HTTPS ƒë·ªÉ d√πng camera.';
  return 'Kh√¥ng m·ªü ƒë∆∞·ª£c camera: ' + msg;
}

async function onDecoded(decodedText){
  const now = Date.now();

  // B·ªè qua n·∫øu ƒëang x·ª≠ l√Ω ho·∫∑c tr√πng n·ªôi dung trong c·ª≠a s·ªï th·ªùi gian
  if (scanLock) return;
  if (decodedText === lastDecodedText && (now - lastDecodedAt) < DUP_WINDOW_MS) return;

  // ƒê·∫∑t kh√≥a ngay l·∫≠p t·ª©c ƒë·ªÉ ch·∫∑n callback k·∫ø ti·∫øp
  scanLock = true;
  lastDecodedText = decodedText;
  lastDecodedAt = now;

  try {
    await sendRaw(decodedText);
  } finally {
    // D·ª´ng camera sau khi c√≥ k·∫øt qu·∫£
    await stopCamera();
    // M·ªü kh√≥a (n·∫øu b·∫°n resume camera sau n√†y)
    scanLock = false;
  }
}

/* ===== Core Scan ===== */
function handleFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    previewImg.src=e.target.result;
    previewImg.style.display='block';
  };
  reader.readAsDataURL(file);
  showLoading();
  const fd=new FormData();
  fd.append('file', file);
  fetch('/scan',{method:'POST', body:fd})
    .then(async r=>{ if(r.status===401){ showLoginNeeded(); return null; } return r.json(); })
    .then(d=>{ if(d) showResult(d); })
    .catch(()=>setResultHTML('<p class="error">L·ªói khi qu√©t.</p>'));
}

function showLoginNeeded(){
  setResultHTML('<div class="error" style="text-align:center">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng. <a href="login.html?next=index.html#scan">ƒêƒÉng nh·∫≠p</a></div>');
}
// s·ª≠a 2 ch·ªó fetch t·ªõi /scan ƒë·ªÉ b·∫Øt 401
async function sendRaw(text){
  if (scanRequestInFlight) return;   // ƒëang c√≥ request tr∆∞·ªõc ƒë√≥
  scanRequestInFlight = true;

  showLoading();
  try{
    const r = await fetch('/scan',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({qr_data:text})
    });
    if(r.status===401){ showLoginNeeded(); return; }
    const data = await r.json();
    showResult(data);
  }catch(e){
    setResultHTML('<p class="error">L·ªói khi qu√©t.</p>');
  }finally{
    scanRequestInFlight = false;
  }
}

function escapeHTML(str){
  return str.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

// Helper nh·∫≠n di·ªán URL ƒë·ªÉ t·∫°o link khi an to√†n
function isLikelyUrl(s){
  if(!s || typeof s!=='string') return false;
  try{ const u = new URL(s); return !!u.protocol && !!u.host; }catch(e){
    return /^https?:\/\/[^\s]+$/i.test(s);
  }
}

function showResult(data){
  const status=classifyStatus(data);
  let html = `<div class="status-line">
      <span class="${status.cls}">${status.label}</span>
      <span class="status-text">${data.result||'K·∫øt qu·∫£'}</span>
  </div>`;

  // WiFi
  if(data.wifi){
    const w = data.wifi;
    html+=`<div class="sub-block">
      <h4>WiFi</h4>
      <div class="kv"><span>T√™n m·∫°ng:</span><code>${escapeHTML(w.ssid||'')}</code></div>
      <div class="kv"><span>M·∫≠t kh·∫©u:</span><code>${escapeHTML(w.password||'(kh√¥ng)')}</code></div>
      <div class="kv"><span>M√£ h√≥a:</span><code>${escapeHTML((w.encryption||'').toUpperCase())}</code></div>
      <div class="kv"><span>·∫®n m·∫°ng:</span><code>${w.hidden ? 'true' : 'false'}</code></div>
    </div>`;
  }

  // Email
  if(data.email){
    const e = data.email;
    html+=`<div class="sub-block">
      <h4>Email</h4>
      <div class="kv"><span>ƒê·∫øn:</span><code>${escapeHTML(e.to||'')}</code></div>
      ${e.cc?`<div class="kv"><span>CC:</span><code>${escapeHTML(e.cc)}</code></div>`:''}
      ${e.bcc?`<div class="kv"><span>BCC:</span><code>${escapeHTML(e.bcc)}</code></div>`:''}
      ${e.subject?`<div class="kv"><span>Ti√™u ƒë·ªÅ:</span><code>${escapeHTML(e.subject)}</code></div>`:''}
      ${e.body?`<div class="kv"><span>N·ªôi dung:</span><pre style="white-space:pre-wrap;margin:6px 0 0;">${escapeHTML(e.body)}</pre></div>`:''}
    </div>`;
  }

  // Phone
  if(data.phone){
    const p = data.phone;
    html+=`<div class="sub-block">
      <h4>ƒêi·ªán tho·∫°i</h4>
      <div class="kv"><span>S·ªë:</span><code>${escapeHTML(p.number||'')}</code></div>
    </div>`;
  }

  // SMS
  if(data.sms){
    const s = data.sms;
    html+=`<div class="sub-block">
      <h4>SMS</h4>
      <div class="kv"><span>S·ªë:</span><code>${escapeHTML(s.number||'')}</code></div>
      ${s.body?`<div class="kv"><span>N·ªôi dung:</span><pre style="white-space:pre-wrap;margin:6px 0 0;">${escapeHTML(s.body)}</pre></div>`:''}
    </div>`;
  }

  // Text
  if(data.text){
    const t = data.text;
    html+=`<div class="sub-block">
      <h4>VƒÉn b·∫£n</h4>
      <pre style="white-space:pre-wrap;word-break:break-word;margin:6px 0 0;">${escapeHTML(t.content||'')}</pre>
    </div>`;
  }

  // Link an to√†n (Clean) -> hi·ªÉn th·ªã ƒë∆∞·ªùng d·∫´n c√≥ th·ªÉ b·∫•m
  const likelyUrl = data && data.data && isLikelyUrl(data.data);
  const vt = data && data.details;
  const safeByVT = !!(vt && vt.total>0 && vt.malicious===0 && vt.suspicious===0);
  const safeByMsg = typeof data.result==='string' && data.result.toLowerCase().includes('an to√†n');

  if(likelyUrl && !data.wifi && !data.email && !data.phone && !data.sms && !data.text && (safeByVT || safeByMsg)){
    const href = data.data;
    html += `<div class="sub-block">
      <h4>Li√™n k·∫øt</h4>
      <a class="safe-link" href="${href}" target="_blank" rel="noopener noreferrer">${escapeHTML(href)}</a>
    </div>`;
  }

  // N·∫øu kh√¥ng ph·∫£i case tr√™n, in n·ªôi dung th√¥
  if(data.data && !data.wifi && !data.text && !data.email && !data.phone && !data.sms && !(likelyUrl && (safeByVT || safeByMsg))){
    html+=`<div class="kv"><span>N·ªôi dung</span><code>${escapeHTML(data.data)}</code></div>`;
  }
  if(data.vietqr_info){
    html+=`<div class="sub-block">
        <h4>VietQR</h4>
        <div class="vietqr">${data.vietqr_info}</div>
    </div>`;
  }
  if(data.details){
    const d=data.details;
    html+=`
    <div class="sub-block">
      <h4>VirusTotal</h4>
      <div class="vt-stats">
        <div class="pill safe">An to√†n: ${d.clean}</div>
        <div class="pill warn">Nghi ng·ªù: ${d.suspicious}</div>
        <div class="pill danger">ƒê·ªôc h·∫°i: ${d.malicious}</div>
        <div class="progress-bar-wrap">
          <div class="seg safe" style="width:${(d.clean/d.total)*100}%"></div>
          <div class="seg warn" style="width:${(d.suspicious/d.total)*100}%"></div>
          <div class="seg danger" style="width:${(d.malicious/d.total)*100}%"></div>
        </div>
        <div class="total small">T·ªïng engine: ${d.total}</div>
      </div>
    </div>`;
  }
  resultDiv.classList.remove('muted');
  setResultHTML(html);
}

// === Navbar auth label/link ===
(async function(){
  const a = document.getElementById('nav-auth'); if(!a) return;
  try{
    const r = await fetch('/me');
    if(r.status===200){ a.textContent='T√†i kho·∫£n'; a.href='account.html'; }
    else{
      a.textContent='ƒêƒÉng nh·∫≠p';
      a.href='login.html?next=' + encodeURIComponent(location.pathname + (location.hash||''));
    }
  }catch{
    a.textContent='ƒêƒÉng nh·∫≠p';
    a.href='login.html?next=' + encodeURIComponent(location.pathname + (location.hash||''));
  }
})();
</script>
</body>
</html>