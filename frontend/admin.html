<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n tr·ªã - QR Checker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Quicksand:400,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
<header class="site-header">
  <nav class="nav">
    <div class="nav__brand">
      <a href="index.html" class="nav__logo">
        <img src="assets/qr-checker-logo.png" alt="QR Checker" class="nav__logo-img">
      </a>
      <span class="nav__title">QR Checker</span>
    </div>
    <input type="checkbox" id="nav-toggle">
    <label for="nav-toggle" class="nav__toggle"><span></span></label>
    <div class="nav__links">
      <a href="about.html">Gi·ªõi thi·ªáu</a>
      <a href="guide.html">H∆∞·ªõng d·∫´n</a>
      <a href="create.html">T·∫°o m√£ QR</a>
      <a href="history.html">L·ªãch s·ª≠</a>
     
      <a id="nav-auth" class="btn-small" href="account.html">T√†i kho·∫£n</a>
    </div>
  </nav>
</header>

<section id="auth-guard" class="scan-wrapper" style="padding-top:40px; display:none;">
  <div class="card" style="max-width:720px;margin:0 auto;text-align:center;">
    <h2>‚õî Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p</h2>
    <p class="small">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n qu·∫£n tr·ªã vi√™n ƒë·ªÉ xem trang n√†y.</p>
    <div class="hero__actions" style="margin-top:12px; display:flex; justify-content:center;">
      <a href="login.html" class="btn btn--primary">ƒêƒÉng nh·∫≠p</a>
      <a href="index.html" class="btn btn--outline">V·ªÅ trang ch·ªß</a>
    </div>
  </div>
</section>

<section id="admin-content" class="scan-wrapper" style="padding-top:40px; display:none;">
  <h1 class="section-title">Qu·∫£n tr·ªã h·ªá th·ªëng</h1>
  
  <!-- Users List -->
  <div class="card" style="max-width:1200px;margin:0 auto 40px;">
    <h3>üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h3>
    <div id="users-list" class="admin-list">
      <div class="loading"><div class="spinner"></div><span>ƒêang t·∫£i...</span></div>
    </div>
  </div>
  
  <!-- User History Modal -->
  <div id="history-modal" class="modal" style="display:none;">
    <div class="modal-overlay" onclick="closeHistoryModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-user-title">L·ªãch s·ª≠ ng∆∞·ªùi d√πng</h2>
        <button class="modal-close" onclick="closeHistoryModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <!-- Stats -->
        <div id="user-stats" class="user-stats">
          <div class="loading"><div class="spinner"></div><span>ƒêang t·∫£i...</span></div>
        </div>
        
        <!-- Tabs -->
        <div class="history-tabs" style="margin-top: 20px;">
          <button class="history-tab active" data-tab="scan">üì± L·ªãch s·ª≠ Qu√©t m√£</button>
          <button class="history-tab" data-tab="create">üé® L·ªãch s·ª≠ T·∫°o m√£</button>
        </div>
        
        <!-- Scan History -->
        <div id="modal-tab-scan" class="tab-content active">
          <div id="modal-scan-history" class="history-list">
            <div class="loading"><div class="spinner"></div><span>ƒêang t·∫£i...</span></div>
          </div>
        </div>
        
        <!-- Create History -->
        <div id="modal-tab-create" class="tab-content">
          <div id="modal-create-history" class="history-list">
            <div class="loading"><div class="spinner"></div><span>ƒêang t·∫£i...</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Subscription Modal -->
  <div id="subscription-modal" class="modal" style="display:none;">
    <div class="modal-overlay" onclick="closeSubscriptionModal()"></div>
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 id="sub-modal-title">Qu·∫£n l√Ω g√≥i</h2>
        <button class="modal-close" onclick="closeSubscriptionModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <h4>Tr·∫°ng th√°i hi·ªán t·∫°i:</h4>
        <div id="sub-current-info">
          <div class="loading"><div class="spinner"></div><span>ƒêang t·∫£i...</span></div>
        </div>
        
        <h4 style="margin-top: 24px;">K√≠ch ho·∫°t g√≥i m·ªõi:</h4>
        <div class="sub-plan-grid">
          <button class="sub-plan-btn" onclick="activateSubscription('1_month')">
            <span class="plan-name">1 th√°ng</span>
            <span class="plan-price">30,000ƒë</span>
          </button>
          <button class="sub-plan-btn" onclick="activateSubscription('3_months')">
            <span class="plan-name">3 th√°ng</span>
            <span class="plan-price">80,000ƒë</span>
          </button>
          <button class="sub-plan-btn" onclick="activateSubscription('6_months')">
            <span class="plan-name">6 th√°ng</span>
            <span class="plan-price">150,000ƒë</span>
          </button>
          <button class="sub-plan-btn" onclick="activateSubscription('1_year')">
            <span class="plan-name">1 nƒÉm</span>
            <span class="plan-price">280,000ƒë</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<footer class="site-footer">
  <div class="footer-grid">
    <div>
      <h4>QR Checker</h4>
      <p class="small">N·ªÅn t·∫£ng ki·ªÉm tra & t·∫°o QR an to√†n.</p>
    </div>
    <div>
      <h5>Ch·ª©c nƒÉng</h5>
      <ul>
        <li><a href="index.html#scan">Qu√©t m√£ QR</a></li>
        <li><a href="create.html">T·∫°o m√£</a></li>
        <li><a href="history.html">L·ªãch s·ª≠</a></li>
      </ul>
    </div>
    <div>
      <h5>H·ªó tr·ª£</h5>
      <ul>
        <li><a href="guide.html">H∆∞·ªõng d·∫´n</a></li>
        <li><a href="about.html">Gi·ªõi thi·ªáu</a></li>
      </ul>
    </div>
  </div>
  <div class="copy small">¬© 2025 QR Checker</div>
</footer>

<script>
let currentUserId = null;

// Auth guard
(async function(){
  const guard = document.getElementById('auth-guard');
  const content = document.getElementById('admin-content');
  const r = await fetch('/me', {credentials:'include'}).catch(()=>null);
  const data = r && r.status === 200 ? await r.json() : null;
  
  if(data && data.is_admin){
    if(content) content.style.display='block';
    if(guard) guard.style.display='none';
    loadUsers();
  } else {
    if(content) content.style.display='none';
    if(guard) guard.style.display='block';
  }
})();

// Load users - C·∫¨P NH·∫¨T
async function loadUsers() {
  const listDiv = document.getElementById('users-list');
  
  try {
    const response = await fetch('/admin/users', { credentials: 'include' });
    const users = await response.json();
    
    if (users.length > 0) {
      // Load subscription info for each user
      const usersWithSub = await Promise.all(users.map(async user => {
        if (user.is_admin) {
          return { ...user, subscription: null };
        }
        try {
          const subRes = await fetch(`/admin/user/${user.id}/subscription`, { credentials: 'include' });
          const subData = await subRes.json();
          return { ...user, subscription: subData };
        } catch {
          return { ...user, subscription: null };
        }
      }));
      
      listDiv.innerHTML = usersWithSub.map(user => {
        let subBadge = '';
        if (user.is_admin) {
          subBadge = '<span class="tag accent">üëë Admin</span>';
        } else if (user.subscription?.has_subscription) {
          const endDate = new Date(user.subscription.end_date).toLocaleDateString('vi-VN');
          subBadge = `<span class="tag safe">‚≠ê ${user.subscription.plan_name} (ƒë·∫øn ${endDate})</span>`;
        } else {
          const remaining = user.subscription?.free_scans_remaining ?? '?';
          const limit = user.subscription?.free_scan_limit ?? 5;
          subBadge = `<span class="tag neutral">üì± Free (${remaining}/${limit} qu√©t)</span>`;
        }
        
        return `
          <div class="admin-user-item">
            <div class="admin-user-info">
              <div class="admin-user-name">
                <strong>${escapeHtml(user.username)}</strong>
                ${subBadge}
              </div>
              <div class="admin-user-email">${escapeHtml(user.email)}</div>
            </div>
            <div class="admin-user-actions">
              <button class="btn btn--outline" onclick="viewUserHistory(${user.id}, '${escapeHtml(user.username)}')">
                üìä L·ªãch s·ª≠
              </button>
              ${!user.is_admin ? `
                <button class="btn btn--primary" onclick="openSubscriptionModal(${user.id}, '${escapeHtml(user.username)}')">
                  üíé Qu·∫£n l√Ω g√≥i
                </button>
                <button class="btn btn--outline" style="color: #dc3545; border-color: #dc3545;" 
                        onclick="deleteUser(${user.id}, '${escapeHtml(user.username)}')">
                  üóëÔ∏è X√≥a
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    } else {
      listDiv.innerHTML = '<p class="empty-message">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o.</p>';
    }
  } catch (error) {
    listDiv.innerHTML = '<p class="error-message">‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch: ' + error.message + '</p>';
  }
}

// Delete user
async function deleteUser(userId, username) {
  if (!confirm(`‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng "${username}"?\n\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a to√†n b·ªô l·ªãch s·ª≠ c·ªßa ng∆∞·ªùi d√πng v√† kh√¥ng th·ªÉ ho√†n t√°c!`)) return;
  
  try {
    const response = await fetch('/admin/delete_user', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ user_id: userId })
    });
    
    const data = await response.json();
    
    if (data.status === 'ok') {
      alert('‚úÖ ƒê√£ x√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng!');
      loadUsers();
    } else {
      alert('‚ùå Kh√¥ng th·ªÉ x√≥a: ' + data.msg);
    }
  } catch (error) {
    alert('‚ùå L·ªói: ' + error.message);
  }
}

// View user history
async function viewUserHistory(userId, username) {
  currentUserId = userId;
  
  const modal = document.getElementById('history-modal');
  const title = document.getElementById('modal-user-title');
  
  title.textContent = `L·ªãch s·ª≠ c·ªßa ${username}`;
  modal.style.display = 'flex';
  
  // Load stats
  await loadUserStats(userId);
  
  // Load histories
  await loadUserScanHistory(userId);
  await loadUserCreateHistory(userId);
}

function closeHistoryModal() {
  document.getElementById('history-modal').style.display = 'none';
  currentUserId = null;
}

// Load user stats
async function loadUserStats(userId) {
  const statsDiv = document.getElementById('user-stats');
  
  try {
    const response = await fetch(`/admin/user/${userId}/history/stats`, { credentials: 'include' });
    const data = await response.json();
    
    if (data.status === 'ok') {
      const stats = data.stats;
      statsDiv.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üì±</div>
            <div class="stat-info">
              <div class="stat-value">${stats.scan.total}</div>
              <div class="stat-label">L∆∞·ª£t qu√©t</div>
            </div>
          </div>
          <div class="stat-card safe">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-info">
              <div class="stat-value">${stats.scan.safe}</div>
              <div class="stat-label">An to√†n</div>
            </div>
          </div>
          <div class="stat-card danger">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-info">
              <div class="stat-value">${stats.scan.danger}</div>
              <div class="stat-label">Nguy hi·ªÉm</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üé®</div>
            <div class="stat-info">
              <div class="stat-value">${stats.create.total}</div>
              <div class="stat-label">M√£ ƒë√£ t·∫°o</div>
            </div>
          </div>
        </div>
      `;
    }
  } catch (error) {
    statsDiv.innerHTML = '<p class="error-message">‚ùå Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™</p>';
  }
}

// Load user scan history
async function loadUserScanHistory(userId) {
  const listDiv = document.getElementById('modal-scan-history');
  
  try {
    const response = await fetch(`/admin/user/${userId}/history/scan`, { credentials: 'include' });
    const data = await response.json();
    
    if (data.status === 'ok' && data.history.length > 0) {
      listDiv.innerHTML = data.history.map(item => {
        const isUrl = item.qr_type === 'url';
        const isSafe = item.is_safe;
        const canClick = isUrl && isSafe && item.details.malicious === 0 && item.details.suspicious === 0;
        
        let contentDisplay = '';
        if (canClick) {
          contentDisplay = `<a href="${escapeHtml(item.qr_content)}" target="_blank" rel="noopener noreferrer" class="history-link">${escapeHtml(item.qr_content.substring(0, 60))}${item.qr_content.length > 60 ? '...' : ''}</a>`;
        } else {
          contentDisplay = `<code>${escapeHtml(item.qr_content.substring(0, 60))}${item.qr_content.length > 60 ? '...' : ''}</code>`;
        }
        
        return `
          <div class="history-item ${item.is_safe ? 'safe' : 'danger'}">
            <div class="history-header">
              <span class="history-type">${getTypeIcon(item.qr_type)} ${getTypeName(item.qr_type)}</span>
            </div>
            <div class="history-content">
              <p>
                ${contentDisplay}
                ${item.is_safe ? 
                  '<span class="tag safe">‚úÖ</span>' : 
                  '<span class="tag danger">‚ö†Ô∏è</span>'
                }
                ${!item.is_safe && item.details.malicious ? 
                  `<span class="tag danger">üî¥ ${item.details.malicious}/${item.details.total}</span>` : 
                  ''
                }
              </p>
            </div>
          </div>
        `;
      }).join('');
    } else {
      listDiv.innerHTML = '<p class="empty-message">Ch∆∞a c√≥ l·ªãch s·ª≠ qu√©t m√£.</p>';
    }
  } catch (error) {
    listDiv.innerHTML = '<p class="error-message">‚ùå Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠</p>';
  }
}

// Load user create history
async function loadUserCreateHistory(userId) {
  const listDiv = document.getElementById('modal-create-history');
  
  try {
    const response = await fetch(`/admin/user/${userId}/history/create`, { credentials: 'include' });
    const data = await response.json();
    
    if (data.status === 'ok' && data.history.length > 0) {
      listDiv.innerHTML = data.history.map(item => {
        const isUrl = item.qr_type === 'url';
        const canClick = isUrl && looks_like_url_content(item.qr_content);
        
        let contentDisplay = '';
        if (canClick) {
          contentDisplay = `<a href="${escapeHtml(item.qr_content)}" target="_blank" rel="noopener noreferrer" class="history-link">${escapeHtml(item.qr_content.substring(0, 60))}${item.qr_content.length > 60 ? '...' : ''}</a>`;
        } else {
          contentDisplay = `<code>${escapeHtml(item.qr_content.substring(0, 60))}${item.qr_content.length > 60 ? '...' : ''}</code>`;
        }
        
        return `
          <div class="history-item create">
            ${item.qr_image ? `<img src="${item.qr_image}" alt="QR" class="history-qr-preview">` : ''}
            <div class="history-content">
              <div class="history-header" style="margin-bottom: 6px;">
                <span class="history-type">${getTypeIcon(item.qr_type)} ${getTypeName(item.qr_type)}</span>
              </div>
              <p>${contentDisplay}</p>
            </div>
            <div class="history-actions">
              ${item.qr_image ? `<a href="${item.qr_image}" download="qrcode.png" class="btn-icon" title="T·∫£i">üíæ</a>` : ''}
            </div>
          </div>
        `;
      }).join('');
    } else {
      listDiv.innerHTML = '<p class="empty-message">Ch∆∞a c√≥ l·ªãch s·ª≠ t·∫°o m√£.</p>';
    }
  } catch (error) {
    listDiv.innerHTML = '<p class="error-message">‚ùå Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠</p>';
  }
}

// Tab switching in modal
document.querySelectorAll('.history-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.dataset.tab;
    
    document.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    document.querySelectorAll('#history-modal .tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`modal-tab-${tabName}`).classList.add('active');
  });
});

// Subscription Modal
let subscriptionUserId = null;
let subscriptionUsername = '';

function openSubscriptionModal(userId, username) {
  subscriptionUserId = userId;
  subscriptionUsername = username;
  
  const modal = document.getElementById('subscription-modal');
  document.getElementById('sub-modal-title').textContent = `Qu·∫£n l√Ω g√≥i - ${username}`;
  modal.style.display = 'flex';
  
  loadUserSubscriptionInfo(userId);
}

function closeSubscriptionModal() {
  document.getElementById('subscription-modal').style.display = 'none';
  subscriptionUserId = null;
  subscriptionUsername = '';
}

async function loadUserSubscriptionInfo(userId) {
  const infoDiv = document.getElementById('sub-current-info');
  
  try {
    const response = await fetch(`/admin/user/${userId}/subscription`, { credentials: 'include' });
    const data = await response.json();
    
    if (data.has_subscription) {
      const endDate = new Date(data.end_date).toLocaleDateString('vi-VN');
      infoDiv.innerHTML = `
        <div class="sub-status premium">
          <h4>‚≠ê ${data.plan_name}</h4>
          <p>H·∫øt h·∫°n: <strong>${endDate}</strong></p>
          <button class="btn btn--outline" style="margin-top: 12px; color: #dc3545; border-color: #dc3545;" 
                  onclick="deactivateSubscription()">‚ùå H·ªßy g√≥i</button>
        </div>
      `;
    } else {
      infoDiv.innerHTML = `
        <div class="sub-status free">
          <h4>üì± G√≥i Mi·ªÖn ph√≠</h4>
          <p>ƒê√£ d√πng: <strong>${data.free_scans_used}/${data.free_scan_limit}</strong> l∆∞·ª£t qu√©t</p>
        </div>
      `;
    }
  } catch (error) {
    infoDiv.innerHTML = '<p class="error-message">‚ùå Kh√¥ng th·ªÉ t·∫£i th√¥ng tin</p>';
  }
}

async function activateSubscription(planType) {
  if (!subscriptionUserId) return;
  
  const planNames = {
    '1_month': 'G√≥i 1 th√°ng',
    '3_months': 'G√≥i 3 th√°ng',
    '6_months': 'G√≥i 6 th√°ng',
    '1_year': 'G√≥i 1 nƒÉm'
  };
  
  if (!confirm(`K√≠ch ho·∫°t ${planNames[planType]} cho ${subscriptionUsername}?`)) return;
  
  try {
    const response = await fetch(`/admin/user/${subscriptionUserId}/subscription/activate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ plan_type: planType })
    });
    
    const data = await response.json();
    
    if (data.status === 'ok') {
      alert(data.msg);
      loadUserSubscriptionInfo(subscriptionUserId);
      loadUsers(); // Reload user list
    } else {
      alert('‚ùå ' + data.msg);
    }
  } catch (error) {
    alert('‚ùå L·ªói: ' + error.message);
  }
}

async function deactivateSubscription() {
  if (!subscriptionUserId) return;
  
  if (!confirm(`H·ªßy g√≥i Premium c·ªßa ${subscriptionUsername}?`)) return;
  
  try {
    const response = await fetch(`/admin/user/${subscriptionUserId}/subscription/deactivate`, {
      method: 'POST',
      credentials: 'include'
    });
    
    const data = await response.json();
    
    if (data.status === 'ok') {
      alert(data.msg);
      loadUserSubscriptionInfo(subscriptionUserId);
      loadUsers();
    } else {
      alert('‚ùå ' + data.msg);
    }
  } catch (error) {
    alert('‚ùå L·ªói: ' + error.message);
  }
}

// Helper functions
function getTypeIcon(type) {
  const icons = { url: 'üîó', text: 'üìù', wifi: 'üì∂', phone: 'üìû', sms: 'üí¨', email: '‚úâÔ∏è' };
  return icons[type] || '‚ùì';
}

function getTypeName(type) {
  const names = { url: 'URL', text: 'VƒÉn b·∫£n', wifi: 'WiFi', phone: 'ƒêi·ªán tho·∫°i', sms: 'SMS', email: 'Email' };
  return names[type] || type;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function looks_like_url_content(content) {
  if (!content) return false;
  return /^(https?|ftp):\/\//i.test(content);
}
</script>
</body>
</html>