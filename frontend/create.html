<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Táº¡o mÃ£ QR - QR Checker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Quicksand:400,600,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
<header class="site-header">
  <nav class="nav">
    <div class="nav__brand">
      <a href="index.html" class="nav__logo">
        <img src="assets/qr-checker-logo.png" alt="QR Checker" class="nav__logo-img">
      </a>
      <span class="nav__title">QR Checker</span>
    </div>
    <input type="checkbox" id="nav-toggle">
    <label for="nav-toggle" class="nav__toggle"><span></span></label>
    <div class="nav__links">
      <a href="about.html">Giá»›i thiá»‡u</a>
      <a href="guide.html">HÆ°á»›ng dáº«n</a>
      <a href="create.html" class="active">Táº¡o mÃ£ QR</a>
      <a href="history.html">Lá»‹ch sá»­</a>
      <a id="nav-auth" class="btn-small" href="login.html">ÄÄƒng nháº­p</a>
    </div>
  </nav>
</header>

<section id="premium-guard" class="scan-wrapper" style="padding-top:40px; display:none;">
  <div class="card" style="max-width:720px;margin:0 auto;text-align:center;">
    <h2>â­ Chá»©c nÄƒng Premium</h2>
    <p class="small">TÃ­nh nÄƒng Táº¡o mÃ£ QR chá»‰ dÃ nh cho tÃ i khoáº£n Premium.</p>
    <p style="margin: 16px 0;">NÃ¢ng cáº¥p ngay Ä‘á»ƒ sá»­ dá»¥ng khÃ´ng giá»›i háº¡n!</p>
    <div class="hero__actions" style="margin-top:12px; display:flex; justify-content:center; gap: 12px;">
      <a href="pricing.html" class="btn btn--primary">ğŸš€ Xem cÃ¡c gÃ³i Premium</a>
      <a href="account.html" class="btn btn--outline">TÃ i khoáº£n</a>
    </div>
  </div>
</section>

<section id="auth-guard" class="scan-wrapper" style="padding-top:40px; display:none;">
  <div class="card" style="max-width:720px;margin:0 auto;text-align:center;">
    <h2>Báº¡n cáº§n Ä‘Äƒng nháº­p</h2>
    <p class="small">HÃ£y Ä‘Äƒng nháº­p Ä‘á»ƒ sá»­ dá»¥ng tÃ­nh nÄƒng Táº¡o mÃ£ QR.</p>
    <div class="hero__actions" style="margin-top:12px; display:flex; justify-content:center;">
      <a id="guard-login" class="btn btn--primary">ÄÄƒng nháº­p</a>
    </div>
  </div>
</section>

<section id="feature-content" class="scan-wrapper" style="padding-top:40px; display:none;">
  <h1 class="section-title">Táº¡o mÃ£ QR</h1>
  
  <div class="scan-grid">
    <!-- Form táº¡o QR -->
    <div class="card card--scan">
      <h3>Chá»n loáº¡i mÃ£ QR</h3>
      
      <!-- Tabs -->
      <div class="qr-tabs">
        <button class="qr-tab active" data-type="url">ğŸ”— URL</button>
        <button class="qr-tab" data-type="text">ğŸ“ Text</button>
        <button class="qr-tab" data-type="wifi">ğŸ“¶ WiFi</button>
        <button class="qr-tab" data-type="phone">ğŸ“ Phone</button>
        <button class="qr-tab" data-type="sms">ğŸ’¬ SMS</button>
        <button class="qr-tab" data-type="email">âœ‰ï¸ Email</button>
      </div>
      
      <!-- Form URL -->
      <form id="form-url" class="qr-form active">
        <div class="form-group">
          <label>URL *</label>
          <input type="text" name="url" placeholder="https://example.com" required>
          <small>Nháº­p Ä‘á»‹a chá»‰ website báº¡n muá»‘n táº¡o mÃ£ QR</small>
        </div>
      
        <button type="submit" class="btn btn--primary full">Táº¡o mÃ£ QR</button>
      </form>
      
      <!-- Form Text -->
      <form id="form-text" class="qr-form">
        <div class="form-group">
          <label>Ná»™i dung *</label>
          <textarea name="content" rows="4" placeholder="Nháº­p vÄƒn báº£n..." required></textarea>
          <small>Tá»‘i Ä‘a 200 kÃ½ tá»± cho QR dá»… quÃ©t</small>
        </div>
        <button type="submit" class="btn btn--primary full">Táº¡o mÃ£ QR</button>
      </form>
      
      <!-- Form WiFi -->
      <form id="form-wifi" class="qr-form">
        <div class="form-group">
          <label>TÃªn WiFi (SSID) *</label>
          <input type="text" name="ssid" placeholder="My WiFi" required>
        </div>
        <div class="form-group">
          <label>Máº­t kháº©u</label>
          <input type="text" name="password" placeholder="********">
        </div>
        <div class="form-group">
          <label>Loáº¡i báº£o máº­t</label>
          <select name="encryption">
            <option value="WPA">WPA/WPA2</option>
            <option value="WEP">WEP</option>
            <option value="nopass">KhÃ´ng máº­t kháº©u</option>
          </select>
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" name="hidden">
            <span>Máº¡ng áº©n (Hidden Network)</span>
          </label>
        </div>
        <button type="submit" class="btn btn--primary full">Táº¡o mÃ£ QR</button>
      </form>
      
      <!-- Form Phone -->
      <form id="form-phone" class="qr-form">
        <div class="form-group">
          <label>Sá»‘ Ä‘iá»‡n thoáº¡i *</label>
          <input type="tel" name="number" placeholder="+84123456789" required>
        </div>
        <button type="submit" class="btn btn--primary full">Táº¡o mÃ£ QR</button>
      </form>
      
      <!-- Form SMS -->
      <form id="form-sms" class="qr-form">
        <div class="form-group">
          <label>Sá»‘ Ä‘iá»‡n thoáº¡i *</label>
          <input type="tel" name="number" placeholder="+84123456789" required>
        </div>
        <div class="form-group">
          <label>Ná»™i dung tin nháº¯n</label>
          <textarea name="body" rows="3" placeholder="Ná»™i dung tin nháº¯n..."></textarea>
        </div>
        <button type="submit" class="btn btn--primary full">Táº¡o mÃ£ QR</button>
      </form>
      
      <!-- Form Email -->
      <form id="form-email" class="qr-form">
        <div class="form-group">
          <label>Email ngÆ°á»i nháº­n *</label>
          <input type="email" name="to" placeholder="email@example.com" required>
        </div>
        <div class="form-group">
          <label>TiÃªu Ä‘á»</label>
          <input type="text" name="subject" placeholder="TiÃªu Ä‘á» email">
        </div>
        <div class="form-group">
          <label>Ná»™i dung</label>
          <textarea name="body" rows="3" placeholder="Ná»™i dung email..."></textarea>
        </div>
        <button type="submit" class="btn btn--primary full">Táº¡o mÃ£ QR</button>
      </form>
    </div>
    
    <!-- Káº¿t quáº£ -->
    <div class="card card--result">
      <h3>MÃ£ QR cá»§a báº¡n</h3>
      <div id="qr-result" class="result-box muted">
        <p>Chá»n loáº¡i vÃ  Ä‘iá»n thÃ´ng tin Ä‘á»ƒ táº¡o mÃ£ QR</p>
      </div>
    </div>
  </div>
</section>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="footer-grid">
    <div>
      <h4>QR Checker</h4>
      <p class="small">Ná»n táº£ng kiá»ƒm tra & táº¡o QR an toÃ n.</p>
    </div>
    <div>
      <h5>Chá»©c nÄƒng</h5>
      <ul>
        <li><a href="index.html#scan">QuÃ©t mÃ£ QR</a></li>
        <li><a href="create.html">Táº¡o mÃ£</a></li>
        <li><a href="history.html">Lá»‹ch sá»­</a></li>
      </ul>
    </div>
    <div>
      <h5>Há»— trá»£</h5>
      <ul>
        <li><a href="guide.html">HÆ°á»›ng dáº«n</a></li>
        <li><a href="about.html">Giá»›i thiá»‡u</a></li>
      </ul>
    </div>
  </div>
  <div class="copy small">Â© 2025 QR Checker</div>
</footer>

<script>
// Auth guard - Cáº¬P NHáº¬T
(async function(){
  const next = location.pathname + location.search + location.hash;
  const a = document.getElementById('nav-auth');
  const authGuard = document.getElementById('auth-guard');
  const premiumGuard = document.getElementById('premium-guard');
  const content = document.getElementById('feature-content');
  
  const r = await fetch('/me', {credentials:'include'}).catch(()=>null);
  const authed = !!r && r.status === 200;

  if(a){
    if(authed){ a.textContent='TÃ i khoáº£n'; a.href='account.html'; }
    else{ a.textContent='ÄÄƒng nháº­p'; a.href='login.html?next=' + encodeURIComponent(location.pathname); }
  }
  
  if(!authed){
    if(content) content.style.display='none';
    if(premiumGuard) premiumGuard.style.display='none';
    if(authGuard) authGuard.style.display='block';
    const btn = document.getElementById('guard-login');
    if(btn) btn.href = 'login.html?next=' + encodeURIComponent(next);
    return;
  }
  
  // Kiá»ƒm tra subscription
  const subRes = await fetch('/subscription/info', {credentials:'include'}).catch(()=>null);
  const subData = subRes && subRes.status === 200 ? await subRes.json() : null;
  
  if(subData && (subData.is_admin || subData.has_subscription)){
    if(content) content.style.display='block';
    if(authGuard) authGuard.style.display='none';
    if(premiumGuard) premiumGuard.style.display='none';
  } else {
    if(content) content.style.display='none';
    if(authGuard) authGuard.style.display='none';
    if(premiumGuard) premiumGuard.style.display='block';
  }
})();

// QR Creation Logic
const tabs = document.querySelectorAll('.qr-tab');
const forms = document.querySelectorAll('.qr-form');
const resultDiv = document.getElementById('qr-result');

// Tab switching
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const type = tab.dataset.type;
    
    // Update active tab
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    // Show corresponding form
    forms.forEach(f => f.classList.remove('active'));
    document.getElementById(`form-${type}`).classList.add('active');
    
    // Reset result
    resultDiv.innerHTML = '<p>Chá»n loáº¡i vÃ  Ä‘iá»n thÃ´ng tin Ä‘á»ƒ táº¡o mÃ£ QR</p>';
    resultDiv.className = 'result-box muted';
  });
});

// Form submissions
forms.forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const type = form.id.replace('form-', '');
    const data = { type };
    
    // Collect form data
    for (let [key, value] of formData.entries()) {
      if (form.elements[key].type === 'checkbox') {
        data[key] = form.elements[key].checked;
      } else {
        data[key] = value.trim();
      }
    }
    
    // Show loading
    resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><span>Äang táº¡o mÃ£ QR...</span></div>';
    resultDiv.className = 'result-box';
    
    try {
      const response = await fetch('/create_qr', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.status === 'ok') {
        resultDiv.innerHTML = `
          <div class="qr-success">
            <div style="background: #d4edda; border: 2px solid #28a745; border-radius: 12px; padding: 12px; margin-bottom: 16px;">
              <strong style="color: #155724;">âœ… ${result.msg}</strong>
            </div>
            <img src="${result.qr_image}" alt="QR Code" class="qr-generated">
            <div class="qr-info">
              <p><strong>Loáº¡i:</strong> ${getTypeName(result.type)}</p>
              <p><strong>Ná»™i dung:</strong> <code>${escapeHtml(result.qr_content)}</code></p>
            </div>
            <div class="qr-actions">
              <a href="${result.qr_image}" download="qrcode.png" class="btn btn--primary">ğŸ’¾ Táº£i xuá»‘ng</a>
              <button onclick="copyToClipboard('${escapeHtml(result.qr_content)}')" class="btn btn--outline">ğŸ“‹ Copy ná»™i dung</button>
            </div>
          </div>
        `;
        resultDiv.className = 'result-box';
      } else {
        // XÃ¡c Ä‘á»‹nh mÃ u sáº¯c dá»±a trÃªn má»©c Ä‘á»™ nguy hiá»ƒm
        let bgColor = '#fff3cd';
        let borderColor = '#ffc107';
        let textColor = '#856404';
        
        if (result.danger_level === 'high') {
          bgColor = '#f8d7da';
          borderColor = '#dc3545';
          textColor = '#721c24';
        } else if (result.danger_level === 'medium') {
          bgColor = '#fff3cd';
          borderColor = '#ffc107';
          textColor = '#856404';
        }
        
        let errorHtml = `
          <div class="error-box" style="background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 12px; padding: 16px;">
            <h4 style="color: ${textColor}; margin-top: 0; white-space: pre-line;">${result.msg}</h4>
        `;
        
        // Hiá»ƒn thá»‹ suggestion náº¿u cÃ³
        if (result.suggestion) {
          const suggestionName = result.suggestion === 'text' ? 'ğŸ“ Text' : 'ğŸ”— URL';
          errorHtml += `
            <button onclick="switchToTab('${result.suggestion}')" class="btn btn--accent" style="margin-top: 12px;">
              Chuyá»ƒn sang tab ${suggestionName}
            </button>
          `;
        }
        
        // Hiá»ƒn thá»‹ chi tiáº¿t VirusTotal náº¿u cÃ³
        if (result.details && result.details.total > 0) {
          errorHtml += `
            <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 8px;">
              <h5 style="margin: 0 0 8px; font-size: 0.9rem;">ğŸ“Š Chi tiáº¿t tá»« VirusTotal:</h5>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <span class="pill danger">ğŸ”´ Äá»™c háº¡i: ${result.details.malicious}</span>
                <span class="pill warn">ğŸŸ¡ ÄÃ¡ng ngá»: ${result.details.suspicious}</span>
                <span class="pill safe">ğŸŸ¢ An toÃ n: ${result.details.clean}</span>
                <span class="pill neutral">Tá»•ng: ${result.details.total}</span>
              </div>
            </div>
          `;
        }
        
        errorHtml += `</div>`;
        resultDiv.innerHTML = errorHtml;
        resultDiv.className = 'result-box';
        
        // Highlight field cÃ³ lá»—i
        if (result.field) {
          const field = form.querySelector(`[name="${result.field}"]`);
          if (field) {
            field.style.borderColor = borderColor;
            field.style.background = bgColor;
            setTimeout(() => {
              field.style.borderColor = '';
              field.style.background = '';
            }, 3000);
          }
        }
      }
    } catch (error) {
      resultDiv.innerHTML = `
        <div class="error-box" style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 12px; padding: 16px;">
          <h4 style="color: #721c24; margin-top: 0;">âŒ Lá»—i káº¿t ná»‘i</h4>
          <p style="color: #721c24;">${error.message}</p>
          <p style="color: #721c24; font-size: 0.85rem; margin-top: 12px;">Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i máº¡ng vÃ  thá»­ láº¡i.</p>
        </div>
      `;
      resultDiv.className = 'result-box';
    }
  });
});

// HÃ m chuyá»ƒn tab (Ä‘á»ƒ suggestion hoáº¡t Ä‘á»™ng)
function switchToTab(type) {
  const targetTab = document.querySelector(`.qr-tab[data-type="${type}"]`);
  if (targetTab) {
    targetTab.click();
  }
}

function getTypeName(type) {
  const names = {
    url: 'ğŸ”— URL',
    text: 'ğŸ“ VÄƒn báº£n',
    wifi: 'ğŸ“¶ WiFi',
    phone: 'ğŸ“ Äiá»‡n thoáº¡i',
    sms: 'ğŸ’¬ SMS',
    email: 'âœ‰ï¸ Email'
  };
  return names[type] || type;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('âœ… ÄÃ£ copy ná»™i dung vÃ o clipboard!');
  }).catch(() => {
    alert('âŒ KhÃ´ng thá»ƒ copy. Vui lÃ²ng copy thá»§ cÃ´ng.');
  });
}
</script>


</body>
</html>